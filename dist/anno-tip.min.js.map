{"version":3,"file":"anno-tip.min.js.map","sources":["../src/TextMonitor.js","../src/AnnoTip.js"],"sourcesContent":["\"use strict\";\n\nimport $ from 'jquery';\n\nconst NS_SEL = \"annotip-text\";\n\nfunction isMultiElement(range1, range2) {\n\treturn $.unique([\n\t\trange1.startContainer, range1.endContainer, \n\t\trange2.startContainer, range2.endContainer\n\t]).length > 0;\n}\n\nfunction normalizeRange(range) {\n\tconst startNode = range.startContainer,\n\t\tendNode = range.endContainer;\n\n\tif (startNode == endNode) {\n\t\tif (range.startOffset > range.endOffset) {\n\t\t\tconst _t = range.startOffset;\n\n\t\t\trange.setStartOffset(range.endOffset);\n\t\t\trange.setEndOffset(_t);\n\t\t}\n\t}\n\n\treturn range;\n}\n\nfunction mergeRanges(ranges) {\n\tif (ranges.length == 0)\n\t\treturn null;\n\tif (ranges.length == 1)\n\t\treturn ranges[0];\n\t\n\t// TODO: Make sure the ranges are properly ordered.\n\tconst lastR = ranges[ranges.length - 1],\n\t\tunitedR = document.createRange();\n\n\tunitedR.setStart(ranges[0].startContainer, ranges[0].startOffset);\n\tunitedR.setEnd(lastR.endContainer, lastR.endOffset);\n\n\treturn unitedR;\n}\n\n\n/**\n * A wrapper of relevant selection data, to be passed to @see {AnnoTip}.\n * @param {String} content The plain text version of the selected content\n * @param {Event} event The event that triggered the selection (mouseup)\n * @param {Array<Range>} ranges The array of ranges, that this selection occupies\n */\nfunction TextSelection(content, event, ranges) {\n\tthis.content = content;\n\tthis.event = event;\n\tthis.range = mergeRanges(ranges);\n\n}\n\nTextSelection.prototype.getElement = function() {\n\tconst parentEl = this.range.commonAncestorContainer;\n\n\treturn parentEl instanceof Element ? parentEl : parentEl.parentElement;\n};\n\nTextSelection.prototype.getBoundingRect = function () {\n\treturn this.range.getBoundingClientRect();\n};\n\n\n/**\n * Initializes a text selection monitoring mechanis.about-content\n * \n * @param {Element} element The parent DOM element to attach the whole text selection monitoring mechanism to.\n * @param {Object} settings Settings for monitoring. Check @see TextSelection.defaults.\n */ \nfunction TextMonitor(element, settings) {\n\tthis.element = element;\n\tthis.settings = $.extend(true, {}, TextMonitor.defaults, settings);\n\n\tif (this.element.ownerDocument) {\n\t\tthis.document = this.element.ownerDocument;\n\t\t\n\t\t$(this.document.body).on('mouseup.' + NS_SEL, (e) => this._handleSelection(e));\n\t} else {\n\t\tthrow new Error(`Non-attached element used for text selection: ${element}`);\n\t}\n}\n\n/**\n * Detach the text selection monitoring mechanism.\n */\nTextMonitor.prototype.detach = function () {\n\tif (this.document)\n\t\t$(this.document.body).off('.' + NS_SEL);\n};\n\n/**\n * Handles the mouse-up event, supposedly after a selection is made.\n * @param event The actual mouse-up event.\n */\nTextMonitor.prototype._handleSelection = function (event) {\n\tconst selection = this.document.getSelection(); // TODO: Check with defaultView\n\n\tif (selection.isCollapsed)\n\t\treturn;\n\t\n\tconst myRanges = [];\n\n\tfor (let i = 0; i < selection.rangeCount; ++i) {\n\t\tconst r = selection.getRangeAt(i);\n\n\t\tif (!$.contains(this.element, r.commonAncestorContainer))\n\t\t\tcontinue;\n\t\telse if (this.multipleNodes || myRanges.length == 0 || !isMultiElement(myRanges[0], r))\n\t\t\tmyRanges.push(normalizeRange(r));\n\t}\n\n\tif (myRanges.length > 0)\n\t\tthis.settings.onSelection(new TextSelection(selection.toString(), event, myRanges));\n};\n\n/**\n * Default options.\n */\nTextMonitor.defaults = {\n\t// Whether selections over more than one element are allowed.\n\tmultipleNodes: false,\n\t// function (content, event, ranges)\n\tonSelection: null\n};\n\nexport default TextMonitor;\n","\"use strict\";\n\nimport $ from 'jquery';\nimport tippy from 'tippy.js';\nimport TextMonitor  from './TextMonitor';\n\nconst NS_ANNO = 'annotip-main';\nconst FRAME_HTML = `\n<div class=\"annotip-frame\">\n\t<div class=\"annotip-dlg\" style=\"display: none\">{{content}}</div>\n\t<div class=\"annotip-actions\">{{actions}}</div>\n</div>`;\n\nconst DEF_ACTIONS = `\n\t<button data-annotip-action=\"cancel\">Cancel</button>\n\t<button data-annotip-action=\"ok\">OK</button>\n`;\n\nfunction fillTemplate(html, obj) {\n\tfor (const prop in obj) {\n\t\tif (!obj.hasOwnProperty(prop))\n\t\t\tcontinue;\n\t\thtml = html.replace(`{{${prop}}}`, obj[prop]);\n\t}\n\n\treturn html;\n}\n\n/**\n * Initialize the annotation engine\n * @param {Object} settings Custom settings for the annotation engine.\n */\nfunction AnnoTip(settings) {\n\tthis.settings = $.extend(true, {}, AnnoTip.defaults, settings);\n\t\n\t// Normalize the settings\n\tif (typeof this.settings.textSelection === 'string')\n\t\tthis.settings.textSelection = this.settings.textSelection.toLowerCase();\n\n\ttippy.setDefaultProps(this.settings.tippySettings);\n\t\n\tthis.selections = [];\n\tthis.tp = null;\n}\n\n/**\n * Attach handlers - both element\n */\nAnnoTip.prototype.attach = function (selector) {\n\t$(selector).each((i, el) => {\n\t\tif (!el.ownerDocument)\n\t\t\tthrow new Error(`Non-attached element used for anno-tip: ${el}`);\n\n\t\tif (this.settings.textSelection && this.settings.textSelection !== 'none') {\n\t\t\tthis.selections.push(new TextMonitor(el, {\n\t\t\t\tmultipleNodes: this.settings.textSelection === 'multi',\n\t\t\t\tonSelection: (content, event, range) => this._handleSelection(content, event, range)\n\t\t\t}));\n\t\t}\n\t});\n};\n\n/**\n * \n */\nAnnoTip.prototype.applyAnnos = function (annos) {\n\tannos.test = \"\";\n};\n\nAnnoTip.prototype.discard = function () {\n\tthis.tp.destroy();\n\tthis.tp = null;\n};\n\n/**\n * Detach the AnnoTip from the page.\n */\nAnnoTip.prototype.detach = function () {\n\t// Destroy the Tippy instance, if such exists.\n\tif (this.tp != null)\n\t\tthis.tp.destroy();\n};\n\nAnnoTip.prototype._getTippyBox = function () {\n\treturn $(\"[class=tippy-box]\");\n};\n\nAnnoTip.prototype._handleSelection = function (selection) {\n\tconst anno = {\n\t\tselection: selection.content,\n\t\trange: selection.range,\n\t\tevent: selection.event\n\t};\n\n\tif (this.tp != null || this._call('onSelection', anno) === false)\n\t\treturn;\n\t\n\t// Cleanup the previous instance, if such was created.\n\tif (this.tp != null)\n\t\tthis.tp.destroy();\n\n\t// Go, and create a new one.\n\tthis.tp = new tippy(selection.getElement(), {\n\t\tcontent: fillTemplate(FRAME_HTML, { \n\t\t\tactions: anno.actionsHtml || this.settings.actionsHtml, \n\t\t\tcontent: anno.content || anno.selection  // TODO: Fix this!\n\t\t}),\n\t\tappendTo: document.body,\n\t\tonShown: () => {\n\t\t\tconst tpBox$ = this._getTippyBox();\n\t\t\t\n\t\t\tanno.element = tpBox$[0];\n\t\t\ttpBox$.on('click.' + NS_ANNO, 'div.annotip-actions button', (e) => {\n\t\t\t\tthis._call('onAction', $(e.currentTarget).data('annotipAction'), anno, e);\n\t\t\t});\n\t\t},\n\t\tonClickOutside: (tp) => tp.destroy(),\n\t\tonHide: () => this._call('onClose', anno) !== false,\n\t\tonDestroy: () => { this.tp = null; },\n\t\tgetReferenceClientRect: () => selection.getBoundingRect()\n\t});\n};\n\nAnnoTip.prototype._call = function (hnd, ...moreArgs) {\n\tif (typeof hnd === 'string')\n\t\thnd = this.settings[hnd];\n\n\treturn typeof hnd === 'function' ? hnd.apply(this, moreArgs) : undefined;\n};\n\nAnnoTip.defaults = {\n\tsubject: null,\n\ttextSelection: true,\n\telementSelection: true,\n\tactionsHtml: DEF_ACTIONS,\n\ttippySettings: {\n\t\tplacement: 'auto',\n\t\thideOnClick: false,\n\t\ttrigger: 'manual',\n\t\tallowHTML: true,\n\t\tinteractive: true,\n\t\tshowOnCreate: true\n\t},\n\t// Handlers. All accept @see {Anno} as an argument.\n\tonSelection: null,\n\tonAction: null,\n\tonClose: null\n};\n\nexport default AnnoTip;\n"],"names":["normalizeRange","range","startContainer","endContainer","startOffset","endOffset","_t","setStartOffset","setEndOffset","TextSelection","content","event","ranges","length","lastR","unitedR","document","createRange","setStart","setEnd","mergeRanges","TextMonitor","element","settings","$","extend","defaults","this","ownerDocument","Error","body","on","e","_this","_handleSelection","prototype","getElement","parentEl","commonAncestorContainer","Element","parentElement","getBoundingRect","getBoundingClientRect","detach","off","selection","getSelection","isCollapsed","range1","range2","myRanges","i","rangeCount","r","getRangeAt","contains","multipleNodes","unique","push","onSelection","toString","fillTemplate","html","obj","prop","hasOwnProperty","replace","AnnoTip","textSelection","toLowerCase","tippy","setDefaultProps","tippySettings","selections","tp","attach","selector","each","el","applyAnnos","annos","test","discard","destroy","_getTippyBox","anno","_call","actions","actionsHtml","appendTo","onShown","tpBox$","_this2","currentTarget","data","onClickOutside","onHide","onDestroy","getReferenceClientRect","hnd","moreArgs","apply","undefined","subject","elementSelection","placement","hideOnClick","trigger","allowHTML","interactive","showOnCreate","onAction","onClose"],"mappings":"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"}