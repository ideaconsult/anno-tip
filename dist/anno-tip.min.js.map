{"version":3,"file":"anno-tip.min.js.map","sources":["../src/TextSelection.js","../src/Anno.js","../src/AnnoTip.js"],"sourcesContent":["\"use strict\";\n\nimport $ from 'jquery';\n\nconst SEL_NS = \"annotip-text\";\n\nfunction isMultiElement(range1, range2) {\n\treturn $.unique([\n\t\trange1.startContainer, range1.endContainer, \n\t\trange2.startContainer, range2.endContainer\n\t]).length > 0;\n}\n\nfunction normalizeRange(range) {\n\tconst startNode = range.startContainer,\n\t\tendNode = range.endContainer;\n\n\tif (startNode == endNode) {\n\t\tif (range.startOffset > range.endOffset) {\n\t\t\tconst _t = range.startOffset;\n\n\t\t\trange.setStartOffset(range.endOffset);\n\t\t\trange.setEndOffset(_t);\n\t\t}\n\t}\n\n\treturn range;\n}\n\nfunction mergeRanges(ranges) {\n\tif (ranges.length == 0)\n\t\treturn null;\n\tif (ranges.length == 1)\n\t\treturn ranges[0];\n\t\n\t// TODO: Make sure the ranges are properly ordered.\n\tconst lastR = ranges[ranges.length - 1],\n\t\tunitedR = document.createRange();\n\n\tunitedR.setStart(ranges[0].startContainer, ranges[0].startOffset);\n\tunitedR.setEnd(lastR.endContainer, lastR.endOffset);\n\n\treturn unitedR;\n}\n\n/**\n * Initializes a text selection monitoring mechanis.about-content\n * \n * @param {Element} element The parent DOM element to attach the whole text selection monitoring mechanism to.\n * @param {Object} settings Settings for monitoring. Check @see TextSelection.defaults.\n */ \nfunction TextSelection(element, settings) {\n\tthis.element = element;\n\tthis.settings = $.extend(true, {}, TextSelection.defaults, settings);\n\n\tif (this.element.ownerDocument) {\n\t\tthis.document = this.element.ownerDocument;\n\t\t\n\t\t$(this.document.body).on(`mouseup.${SEL_NS}`, (e) => {\n\t\t\tthis._handleSelection(e);\n\t\t});\n\t} else {\n\t\tthrow new Error(`Non-attached element used for text selection: ${element}`);\n\t}\n}\n\n/**\n * Detach the text selection monitoring mechanism.\n */\nTextSelection.prototype.detach = function () {\n\tif (this.document)\n\t\t$(this.document.body).off(`.${SEL_NS}`);\n};\n\n\n/**\n * Handles the mouse-up event, supposedly after a selection is made.\n * @param event The actual mouse-up event.\n */\nTextSelection.prototype._handleSelection = function (event) {\n\tconst selection = this.document.getSelection(); // TODO: Check with defaultView\n\n\tif (selection.isCollapsed)\n\t\treturn;\n\t\n\tconst myRanges = [];\n\n\tfor (let i = 0; i < selection.rangeCount; ++i) {\n\t\tconst r = selection.getRangeAt(i);\n\n\t\tif (!$.contains(this.element, r.commonAncestorContainer))\n\t\t\tcontinue;\n\t\telse if (this.multipleNodes || myRanges.length == 0 || !isMultiElement(myRanges[0], r))\n\t\t\tmyRanges.push(normalizeRange(r));\n\t}\n\n\tif (myRanges.length > 0)\n\t\tthis.settings.onSelection(selection.toString(), event, mergeRanges(myRanges));\n};\n\n/**\n * Default options.\n */\nTextSelection.defaults = {\n\t// Whether selections over more than one element are allowed.\n\tmultipleNodes: false,\n\t// function (content, event, ranges)\n\tonSelection: null\n};\n\nexport default TextSelection;\n","\"use strict\";\n\nimport $ from 'jquery';\n\n\nfunction Anno(obj) {\n\tfor (const k in obj)\n\t\tif (obj.hasOwnProperty(k))\n\t\t\tthis[k] = obj[k];\n}\n\nAnno.prototype.setContent = function (html) {\n\t// TODO: Placeholder!\n\tdocument.getElementById(html);\n};\n\nAnno.prototype.getResponse = function () {\n\n};\n\nAnno.prototype.getManager = function () {\n\treturn this.manager;\n};\n\n\nAnno.prototype.getElement = function () {\n\tconst parentEl = this.range.commonAncestorContainer;\n\n\treturn parentEl instanceof Element ? parentEl : parentEl.parentElement;\n};\n\nAnno.prototype.getBoundingRect = function() {\n\treturn this.range.getBoundingClientRect();\n};\n\nexport default Anno;\n","\"use strict\";\n\nimport $ from 'jquery';\nimport tippy from 'tippy.js';\nimport TextSelection  from './TextSelection';\nimport Anno from './Anno';\n\n// const NS_ANNO = 'annotip-main';\n\nfunction isSelf(element) {\n    const elAndParents = $(element).parents().addBack();\n\t\n\treturn elAndParents.filter('[class=tippy-box]').length !== 0;\n}\n\n/**\n * Initialize the annotation engine\n * @param {Object} settings Custom settings for the annotation engine.\n */\nfunction AnnoTip(settings) {\n\tthis.settings = $.extend(true, {}, AnnoTip.defaults, settings);\n\t\n\t// Normalize the settings\n\tif (typeof this.settings.textSelection === 'string')\n\t\tthis.settings.textSelection = this.settings.textSelection.toLowerCase();\n\n\ttippy.setDefaultProps(this.settings.tippySettings);\n\t\n\tthis.selections = [];\n}\n\n/**\n * Attach handlers - both element\n */\nAnnoTip.prototype.attach = function (selector) {\n\t$(selector).each((i, el) => {\n\t\tif (this.settings.textSelection && this.settings.textSelection !== 'none') {\n\t\t\tthis.selections.push(new TextSelection(el, {\n\t\t\t\tmultipleNodes: this.settings.textSelection === 'multi',\n\t\t\t\tonSelection: (content, event, range) => this._handleSelection(content, event, range)\n\t\t\t}));\n\t\t}\n\t});\n};\n\n/**\n * \n */\nAnnoTip.prototype.applyAnnos = function (annos) {\n\tannos.test = \"\";\n};\n\n/**\n * Detach the AnnoTip from the page.\n */\nAnnoTip.prototype.detach = function () {\n\t// Destroy the Tippy instance, if such exists.\n\tif (this.tp != null)\n\t\tthis.tp.destroy();\n\n\t// Go, and detach all selection monitors.\n\t$.each(this.selections, (i, s) => {\n\t\ts.detach();\n\t});\n};\n\nAnnoTip.prototype._handleSelection = function (content, event, range) {\n\tconst anno = new Anno({\n\t\tmanager: this,\n\t\tcontent: content,\n\t\trange: range,\n\t\tevent: event\n\t});\n\tconst domEl = anno.getElement();\n\n\tif (isSelf(domEl) || this._call('afterSelection', anno) === false)\n\t\treturn;\n\t\n\t// Cleanup the previous instance, if such was created.\n\tif (this.tp != null)\n\t\tthis.tp.destroy();\n\n\t// Go, and create a new one.\n\tthis.tp = new tippy(domEl, {\n\t\tcontent: content,\n\t\tappendTo: document.body,\n\t\tgetReferenceClientRect: () => anno.getBoundingRect()\n\t});\n};\n\nAnnoTip.prototype._call = function (hnd, ...moreArgs) {\n\tif (typeof hnd === 'string')\n\t\thnd = this.settings[hnd];\n\n\treturn typeof hnd === 'function' ? hnd.apply(this, moreArgs) : undefined;\n};\n\nAnnoTip.defaults = {\n\tsubject: null,\n\ttextSelection: true,\n\telementSelection: true,\n\ttippySettings: {\n\t\tplacement: 'auto',\n\t\thideOnClick: true,\n\t\ttrigger: 'manual',\n\t\tallowHTML: true,\n\t\tinteractive: true,\n\t\tshowOnCreate: true\n\t},\n\t// Handlers. All accept @see {Anno} as an argument.\n\tafterSelection: null,\n\tbeforeAnno: null,\n\tafterAnno: null\n};\n\nexport default AnnoTip;\n"],"names":["normalizeRange","range","startContainer","endContainer","startOffset","endOffset","_t","setStartOffset","setEndOffset","TextSelection","element","settings","$","extend","defaults","this","ownerDocument","Error","document","body","on","e","_this","_handleSelection","Anno","obj","k","hasOwnProperty","AnnoTip","textSelection","toLowerCase","tippy","setDefaultProps","tippySettings","selections","prototype","detach","off","event","selection","getSelection","isCollapsed","range1","range2","myRanges","i","rangeCount","r","getRangeAt","contains","commonAncestorContainer","multipleNodes","length","unique","push","onSelection","toString","ranges","lastR","unitedR","createRange","setStart","setEnd","mergeRanges","setContent","html","getElementById","getResponse","getManager","manager","getElement","parentEl","Element","parentElement","getBoundingRect","getBoundingClientRect","attach","selector","each","el","content","applyAnnos","annos","test","tp","destroy","s","anno","domEl","parents","addBack","filter","_call","appendTo","getReferenceClientRect","hnd","moreArgs","apply","undefined","subject","elementSelection","placement","hideOnClick","trigger","allowHTML","interactive","showOnCreate","afterSelection","beforeAnno","afterAnno"],"mappings":"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"}