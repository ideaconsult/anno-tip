{"version":3,"file":"anno-tip.js.map","sources":["../src/TextSelection.js","../src/Anno.js","../src/AnnoTip.js"],"sourcesContent":["\"use strict\";\n\nimport $ from 'jquery';\n\nconst SEL_NS = \"annotip-text\";\n\nfunction isMultiElement(range1, range2) {\n\treturn $.unique([\n\t\trange1.startContainer, range1.endContainer, \n\t\trange2.startContainer, range2.endContainer\n\t]).length > 0;\n}\n\nfunction normalizeRange(range) {\n\tconst startNode = range.startContainer,\n\t\tendNode = range.endContainer;\n\n\tif (startNode == endNode) {\n\t\tif (range.startOffset > range.endOffset) {\n\t\t\tconst _t = range.startOffset;\n\n\t\t\trange.setStartOffset(range.endOffset);\n\t\t\trange.setEndOffset(_t);\n\t\t}\n\t}\n\n\treturn range;\n}\n\nfunction mergeRanges(ranges) {\n\tif (ranges.length == 0)\n\t\treturn null;\n\tif (ranges.length == 1)\n\t\treturn ranges[0];\n\t\n\t// TODO: Make sure the ranges are properly ordered.\n\tconst lastR = ranges[ranges.length - 1],\n\t\tunitedR = document.createRange();\n\n\tunitedR.setStart(ranges[0].startContainer, ranges[0].startOffset);\n\tunitedR.setEnd(lastR.endContainer, lastR.endOffset);\n\n\treturn unitedR;\n}\n\n/**\n * Initializes a text selection monitoring mechanis.about-content\n * \n * @param {Element} element The parent DOM element to attach the whole text selection monitoring mechanism to.\n * @param {Object} settings Settings for monitoring. Check @see TextSelection.defaults.\n */ \nfunction TextSelection(element, settings) {\n\tthis.element = element;\n\tthis.settings = $.extend(true, {}, TextSelection.defaults, settings);\n\n\tif (this.element.ownerDocument) {\n\t\tthis.document = this.element.ownerDocument;\n\t\t\n\t\t$(this.document.body).on(`mouseup.${SEL_NS}`, (e) => {\n\t\t\tthis._handleSelection(e);\n\t\t});\n\t} else {\n\t\tthrow new Error(`Non-attached element used for text selection: ${element}`);\n\t}\n}\n\n/**\n * Detach the text selection monitoring mechanism.\n */\nTextSelection.prototype.detach = function () {\n\tif (this.document)\n\t\t$(this.document.body).off(`.${SEL_NS}`);\n};\n\n\n/**\n * Handles the mouse-up event, supposedly after a selection is made.\n * @param event The actual mouse-up event.\n */\nTextSelection.prototype._handleSelection = function (event) {\n\tconst selection = this.document.getSelection(); // TODO: Check with defaultView\n\n\tif (selection.isCollapsed)\n\t\treturn;\n\t\n\tconst myRanges = [];\n\n\tfor (let i = 0; i < selection.rangeCount; ++i) {\n\t\tconst r = selection.getRangeAt(i);\n\n\t\tif (!$.contains(this.element, r.commonAncestorContainer))\n\t\t\tcontinue;\n\t\telse if (this.multipleNodes || myRanges.length == 0 || !isMultiElement(myRanges[0], r))\n\t\t\tmyRanges.push(normalizeRange(r));\n\t}\n\n\tif (myRanges.length > 0)\n\t\tthis.settings.onSelection(selection.toString(), event, mergeRanges(myRanges));\n};\n\n/**\n * Default options.\n */\nTextSelection.defaults = {\n\t// Whether selections over more than one element are allowed.\n\tmultipleNodes: false,\n\t// function (content, event, ranges)\n\tonSelection: null\n};\n\nexport default TextSelection;\n","\"use strict\";\n\nimport $ from 'jquery';\n\n\nfunction Anno(obj) {\n\tfor (const k in obj)\n\t\tif (obj.hasOwnProperty(k))\n\t\t\tthis[k] = obj[k];\n}\n\nAnno.prototype.setContent = function (html) {\n\t// TODO: Placeholder!\n\tdocument.getElementById(html);\n};\n\nAnno.prototype.getResponse = function () {\n\n};\n\nAnno.prototype.getManager = function () {\n\treturn this.manager;\n};\n\n\nAnno.prototype.getElement = function () {\n\tconst parentEl = this.range.commonAncestorContainer;\n\n\treturn parentEl instanceof Element ? parentEl : parentEl.parentElement;\n};\n\nAnno.prototype.getBoundingRect = function() {\n\treturn this.range.getBoundingClientRect();\n};\n\nexport default Anno;\n","\"use strict\";\n\nimport $ from 'jquery';\nimport tippy from 'tippy.js';\nimport TextSelection  from './TextSelection';\nimport Anno from './Anno';\n\n// const NS_ANNO = 'annotip-main';\n\nfunction isSelf(element) {\n    const elAndParents = $(element).parents().addBack();\n\t\n\treturn elAndParents.filter('[class=tippy-box]').length !== 0;\n}\n\n/**\n * Initialize the annotation engine\n * @param {Object} settings Custom settings for the annotation engine.\n */\nfunction AnnoTip(settings) {\n\tthis.settings = $.extend(true, {}, AnnoTip.defaults, settings);\n\t\n\t// Normalize the settings\n\tif (typeof this.settings.textSelection === 'string')\n\t\tthis.settings.textSelection = this.settings.textSelection.toLowerCase();\n\n\ttippy.setDefaultProps(this.settings.tippySettings);\n\t\n\tthis.selections = [];\n}\n\n/**\n * Attach handlers - both element\n */\nAnnoTip.prototype.attach = function (selector) {\n\t$(selector).each((i, el) => {\n\t\tif (this.settings.textSelection && this.settings.textSelection !== 'none') {\n\t\t\tthis.selections.push(new TextSelection(el, {\n\t\t\t\tmultipleNodes: this.settings.textSelection === 'multi',\n\t\t\t\tonSelection: (content, event, range) => this._handleSelection(content, event, range)\n\t\t\t}));\n\t\t}\n\t});\n};\n\n/**\n * \n */\nAnnoTip.prototype.applyAnnos = function (annos) {\n\tannos.test = \"\";\n};\n\n/**\n * Detach the AnnoTip from the page.\n */\nAnnoTip.prototype.detach = function () {\n\t// Destroy the Tippy instance, if such exists.\n\tif (this.tp != null)\n\t\tthis.tp.destroy();\n\n\t// Go, and detach all selection monitors.\n\t$.each(this.selections, (i, s) => {\n\t\ts.detach();\n\t});\n};\n\nAnnoTip.prototype._handleSelection = function (content, event, range) {\n\tconst anno = new Anno({\n\t\tmanager: this,\n\t\tcontent: content,\n\t\trange: range,\n\t\tevent: event\n\t});\n\tconst domEl = anno.getElement();\n\n\tif (isSelf(domEl) || this._call('afterSelection', anno) === false)\n\t\treturn;\n\t\n\t// Cleanup the previous instance, if such was created.\n\tif (this.tp != null)\n\t\tthis.tp.destroy();\n\n\t// Go, and create a new one.\n\tthis.tp = new tippy(domEl, {\n\t\tcontent: content,\n\t\tappendTo: document.body,\n\t\tgetReferenceClientRect: () => anno.getBoundingRect()\n\t});\n};\n\nAnnoTip.prototype._call = function (hnd, ...moreArgs) {\n\tif (typeof hnd === 'string')\n\t\thnd = this.settings[hnd];\n\n\treturn typeof hnd === 'function' ? hnd.apply(this, moreArgs) : undefined;\n};\n\nAnnoTip.defaults = {\n\tsubject: null,\n\ttextSelection: true,\n\telementSelection: true,\n\ttippySettings: {\n\t\tplacement: 'auto',\n\t\thideOnClick: true,\n\t\ttrigger: 'manual',\n\t\tallowHTML: true,\n\t\tinteractive: true,\n\t\tshowOnCreate: true\n\t},\n\t// Handlers. All accept @see {Anno} as an argument.\n\tafterSelection: null,\n\tbeforeAnno: null,\n\tafterAnno: null\n};\n\nexport default AnnoTip;\n"],"names":["SEL_NS","isMultiElement","range1","range2","$","unique","startContainer","endContainer","length","normalizeRange","range","startNode","endNode","startOffset","endOffset","_t","setStartOffset","setEndOffset","mergeRanges","ranges","lastR","unitedR","document","createRange","setStart","setEnd","TextSelection","element","settings","extend","defaults","ownerDocument","body","on","e","_handleSelection","Error","prototype","detach","off","event","selection","getSelection","isCollapsed","myRanges","i","rangeCount","r","getRangeAt","contains","commonAncestorContainer","multipleNodes","push","onSelection","toString","Anno","obj","k","hasOwnProperty","setContent","html","getElementById","getResponse","getManager","manager","getElement","parentEl","Element","parentElement","getBoundingRect","getBoundingClientRect","isSelf","elAndParents","parents","addBack","filter","AnnoTip","textSelection","toLowerCase","tippy","setDefaultProps","tippySettings","selections","attach","selector","each","el","content","applyAnnos","annos","test","tp","destroy","s","anno","domEl","_call","appendTo","getReferenceClientRect","hnd","moreArgs","apply","undefined","subject","elementSelection","placement","hideOnClick","trigger","allowHTML","interactive","showOnCreate","afterSelection","beforeAnno","afterAnno"],"mappings":"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"}